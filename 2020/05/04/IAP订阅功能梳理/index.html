<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    
    <title>
        IAP订阅功能梳理 |
        
        舜子</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="会员功能需要接入 IAP 订阅功能,  SKU -&gt; 连续包年(首月免费);连续包月(前3天免费);连续包季(首周免费) 前提: 系统已经有交易系统, 下面的描述只针对 连续订阅产品    需求 用户订阅后，获得会员资格, 且每次扣费会有对应的订单(包含免费试用阶段的订单)  苹果支付背景 苹果支付的核心是  收据(receipt)  连续订阅产品的话: 第一次产生收据是一直可用的 (ca">
<meta property="og:type" content="article">
<meta property="og:title" content="IAP订阅功能梳理">
<meta property="og:url" content="https://dadoudou.me/2020/05/04/IAP%E8%AE%A2%E9%98%85%E5%8A%9F%E8%83%BD%E6%A2%B3%E7%90%86/">
<meta property="og:site_name" content="舜子">
<meta property="og:description" content="会员功能需要接入 IAP 订阅功能,  SKU -&gt; 连续包年(首月免费);连续包月(前3天免费);连续包季(首周免费) 前提: 系统已经有交易系统, 下面的描述只针对 连续订阅产品    需求 用户订阅后，获得会员资格, 且每次扣费会有对应的订单(包含免费试用阶段的订单)  苹果支付背景 苹果支付的核心是  收据(receipt)  连续订阅产品的话: 第一次产生收据是一直可用的 (ca">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://dadoudou.me/2020/05/04/IAP%E8%AE%A2%E9%98%85%E5%8A%9F%E8%83%BD%E6%A2%B3%E7%90%86/image-20200504170848061.png">
<meta property="og:image" content="https://dadoudou.me/2020/05/04/IAP%E8%AE%A2%E9%98%85%E5%8A%9F%E8%83%BD%E6%A2%B3%E7%90%86/image-20200504163524179.png">
<meta property="article:published_time" content="2020-05-04T00:10:08.000Z">
<meta property="article:modified_time" content="2020-05-05T10:46:50.909Z">
<meta property="article:author" content="zs1621">
<meta property="article:tag" content="Applepay">
<meta property="article:tag" content="iap">
<meta property="article:tag" content="业务功能">
<meta property="article:tag" content="交易系统">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://dadoudou.me/2020/05/04/IAP%E8%AE%A2%E9%98%85%E5%8A%9F%E8%83%BD%E6%A2%B3%E7%90%86/image-20200504170848061.png">
    
    
    
        
            <link rel="stylesheet" href="https://dadoudou.me/css/markdown.css">
        
            <link rel="stylesheet" href="https://dadoudou.me/css/july.css">
        
    
<meta name="generator" content="Hexo 4.2.0"></head>
<body>

<div id="banner-outer" class="hidden">
    <div id="banner-image" style="background-image: url()"></div>
    <img src="https://www.gravatar.com/avatar/7a585313ed855e8d652cbb3154a6056e?s=300&amp;d=mm&amp;r=g" id="avatar">
</div>

<div id="menu-outer">
    <div id="menu-inner">
        
            <a class="false" href="https://dadoudou.me/index.html">Home</a>
        
            <a class="false" href="https://dadoudou.me/archives/index.html">Archives</a>
        
            <a class="false" href="https://dadoudou.me/about/index.html">About</a>
        
    </div>
</div>

<div id="content-outer" class="container">
    <div id="content-inner">
        <article id="post">
    <h1 id="post-title">IAP订阅功能梳理</h1>
    <time id="post-date" datetime="2020-05-04T00:10:08.000Z">
        五月 04, 2020
    </time>
    <div id="post-content" class="markdown-body">
        <blockquote>
<p>会员功能需要接入 IAP 订阅功能,  SKU -&gt; 连续包年(首月免费);连续包月(前3天免费);连续包季(首周免费)</p>
<p>前提: 系统已经有交易系统, 下面的描述只针对 连续订阅产品  </p>
</blockquote>
<h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><ul>
<li>用户订阅后，获得会员资格, 且每次扣费会有对应的订单(包含免费试用阶段的订单)</li>
</ul>
<h3 id="苹果支付背景"><a href="#苹果支付背景" class="headerlink" title="苹果支付背景"></a>苹果支付背景</h3><ul>
<li><p>苹果支付的核心是  收据(receipt)</p>
<ul>
<li>连续订阅产品的话: 第一次产生收据是一直可用的 (can verify) 每次续订/恢复购买的记录都「保存」在收据里， 业务逻辑核心就是理解 receipt 里的字段 </li>
</ul>
</li>
<li><p>涉及到的人员</p>
<ul>
<li>设计:  设计购买页面</li>
<li>产品:   产品交互/辅助开发 在 app_store 创建产品 </li>
<li>IOS 开发: 初始化购买</li>
<li>服务器开发: 验证客户端上传收据，并管理用户续费订单</li>
</ul>
</li>
</ul>
<h3 id="开发流程简述"><a href="#开发流程简述" class="headerlink" title="开发流程简述"></a>开发流程简述</h3><ul>
<li>产品将 产品列表创建好 </li>
</ul>
<table>
<thead>
<tr>
<th>App product_id</th>
<th>服务器后台 sku</th>
<th>价格</th>
<th>优惠说明</th>
<th>标题</th>
</tr>
</thead>
<tbody><tr>
<td>product_year_xxx</td>
<td>xxxx</td>
<td>100</td>
<td>首月免费</td>
<td>连续包年</td>
</tr>
<tr>
<td>product_quarter_xxx</td>
<td>xxx</td>
<td>50</td>
<td>首周免费</td>
<td>连续包季</td>
</tr>
<tr>
<td>product_month_xxx</td>
<td>xxxx</td>
<td>30</td>
<td>3天免费</td>
<td>连续包月</td>
</tr>
</tbody></table>
<ul>
<li><p>IOS 客户端 可以从苹果拿到 product_id 列表开始测试</p>
<ul>
<li>目的: 产生 receipt 交给服务器设计表结构</li>
<li>走具体流程</li>
</ul>
<p><img src="./image-20200504170848061.png" alt="image-20200504170848061"></p>
</li>
<li><p>服务器具体要做的事</p>
<ul>
<li>产品列表接口: 提供可购买的 product_id, 以及当前用户的订阅状态; 如果已订阅那么禁止用户继续订阅</li>
<li>验证收据接口: 服务器收到 receipt 先在本地通过单元测试解析并结合文档(<a href="https://developer.apple.com/documentation/appstorereceipts)梳理" target="_blank" rel="noopener">https://developer.apple.com/documentation/appstorereceipts)梳理</a> </li>
<li>定时任务:  检测 payment_applepay 数据 按过期了一个月/将要过期的 订单每隔6h 轮询一次 业务逻辑同 （验证收据接口）</li>
</ul>
</li>
</ul>
<h3 id="服务器表结构设计"><a href="#服务器表结构设计" class="headerlink" title="服务器表结构设计"></a>服务器表结构设计</h3><ul>
<li>验证动作表<ul>
<li>记录每次验证 receipt 的 request_data 以及 response_data 方便测试和复盘</li>
</ul>
</li>
</ul>
<pre><code class="mysql">/******************************************/
/*   DatabaseName = trade   */
/*   TableName = trade_payment_applepay_verify   */
/******************************************/
CREATE TABLE `trade_payment_applepay_verify` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `created` datetime(6) NOT NULL,
  `modified` datetime(6) NOT NULL,
  `is_removed` tinyint(1) NOT NULL,
  `user_id` int(11) NOT NULL,
  `action_type` varchar(32) NOT NULL DEFAULT &#39;client&#39; COMMENT &#39;验证类型,客户端验证(client);服务器轮询验证(server_crontab)&#39;,
  `order_no` varchar(64) NOT NULL,
  `receipt_data` longtext NOT NULL COMMENT &#39;待验证的收据&#39;,
  `status` int(11) NOT NULL COMMENT &#39;验证状态 成功/失败&#39;,
  `environment` varchar(16) NOT NULL COMMENT &#39;sandbox/production&#39;,
  `is_retryable` tinyint(1) NOT NULL,
  `latest_receipt` longtext NOT NULL COMMENT &#39;response: latest_receipt&#39;,
  `latest_receipt_info` longtext NOT NULL COMMENT &#39; response: latest_receiptjson对象&#39;,
  `pending_renewal_info` longtext NOT NULL COMMENT &#39;response: pending_renewal_info&#39;,
  `receipt` longtext NOT NULL COMMENT &#39;response: receipt&#39;,
  PRIMARY KEY (`id`),
  KEY `trade_payment_applepay_verify_user_id_4c0bc485_idx` (`user_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8
;</code></pre>
<ul>
<li>对应 receipt 的 in-app 列表 就是对应的每个 transcation_id <ul>
<li>记录每次购买 、 续费、恢复购买数据 </li>
</ul>
</li>
</ul>
<pre><code class="mysql">/******************************************/
/*   DatabaseName = trade   */
/*   TableName = trade_payment_applepay   */
/******************************************/
CREATE TABLE `trade_payment_applepay` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `created` datetime(6) NOT NULL,
  `modified` datetime(6) NOT NULL,
  `is_removed` tinyint(1) NOT NULL,
  `user_id` int(11) NOT NULL,
  `action_type` varchar(32) NOT NULL DEFAULT &#39;client&#39;,
  `order_no` varchar(64) NOT NULL  DEFAULT &#39;&#39; COMMENT &#39;对应订单 订单创建成功后赋值&#39;,
  `paid_time` bigint(20) DEFAULT NULL,
  `status` varchar(100) NOT NULL,
  `status_changed` datetime(6) NOT NULL,
  `bundle_id` varchar(32) NOT NULL,
  `application_version` varchar(16) NOT NULL,
  `original_application_version` varchar(16) NOT NULL,
  `version_external_identifier` varchar(16) NOT NULL,
  `app_item_id` varchar(16) NOT NULL,
  `product_id` varchar(64) NOT NULL DEFAULT &#39;&#39;,
  `quantity` int(10) unsigned NOT NULL,
  `environment` varchar(16) NOT NULL,
  `transaction_id` varchar(32) NOT NULL COMMENT &#39;每次交易 id 注意恢复购买时不需要&#39;,
  `original_transaction_id` varchar(32) NOT NULL COMMENT &#39;原交易 id&#39;,
  `expires_date` datetime(6) DEFAULT NULL COMMENT &#39;过期时间&#39;,
  `expires_date_ms` bigint(20) NOT NULL COMMENT &#39;过期时间 ms&#39;,
  `purchase_date_ms` bigint(20) NOT NULL COMMENT &#39;购买时间 ms&#39;, 
  `purchase_date` varchar(64) NOT NULL  COMMENT &#39;购买时间&#39;,
  `auto_renew_status` tinyint(1) NOT NULL COMMENT &#39;续费状态&#39;, 
  `is_in_intro_offer_period` tinyint(1) NOT NULL COMMENT &#39;An indicator of whether an auto-renewable subscription is in the introductory price period&#39;,
  `is_trial_period` tinyint(1) NOT NULL COMMENT &#39;是否是使用期间&#39;,
  `latest_receipt` longtext NOT NULL COMMENT &#39;最后一次的收据&#39;,
  `web_order_line_item_id` varchar(64) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `trade_payment_applepay_transaction_id_product_i_7f940417_uniq` (`original_transaction_id`,`product_id`,`expires_date_ms`) USING BTREE,
  KEY `trade_payment_applepay_user_id_9e9b627e_idx` (`user_id`),
  KEY `trade_payment_applepay_transaction_id_f8abbb58_idx` (`transaction_id`),
  KEY `trade_payment_applepay_order_no_0ad1fa70_idx` (`order_no`),
  KEY `trade_payment_applepay_original_transaction_id_7746fd50_idx` (`original_transaction_id`)
) ENGINE=InnoDB AUTO_INCREMENT=337 DEFAULT CHARSET=utf8
;
</code></pre>
<h4 id="字段设计以及-Why"><a href="#字段设计以及-Why" class="headerlink" title="字段设计以及 Why"></a>字段设计以及 Why</h4><ul>
<li><p><code>original_transaction_id</code>,<code>product_id</code>,<code>expires_date_ms</code> 组合 unique_key 唯一索引</p>
<blockquote>
<p>对于连续订阅产品 orginal_transaction_id 只有一个, 区分每次订阅/续期的就是  expires_date_ms(每次续费时间会不一样) 和 product_id(更换产品比如从  连续包年-&gt;连续包月 )</p>
</blockquote>
</li>
<li><p>payment_applepay 为什么需要 order_no</p>
<blockquote>
<p>关联 order 才知道这单处理过 防止丢单</p>
</blockquote>
</li>
<li><p>怎么判断需不需要创建订单? </p>
<blockquote>
<p>解析in-app里的数据,  </p>
<ol>
<li>如果此时是插入数据 且 expires_date_ms &gt; now  就表明用户续费了或者刚购买 需要创建订单</li>
<li>如果此时payment 数据已存在, 且 expires_date_ms &gt; now  且 order_no 没赋值, 那么说明漏单了, 创建订单 </li>
<li>如果 is_trial_period or is_in_intro_offer_period 就要注意创建试用订单 此时用户还没真正付钱所以权益之只分配是用权限 比如 首月免费 那就创建首月免费订单 , 等苹果扣费时,  验证苹果 receipt 时 会新增一个 transaction_id 表明付款了</li>
</ol>
</blockquote>
</li>
</ul>
<h3 id="测试流程"><a href="#测试流程" class="headerlink" title="测试流程"></a>测试流程</h3><ul>
<li>了解 in-app-purchase sandbox 背景  如下图</li>
</ul>
<p><img src="./image-20200504163524179.png" alt="image-20200504163524179.png"></p>
<h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><ul>
<li>苹果还有订阅 subscribe 接口, <a href="https://developer.apple.com/documentation/appstoreservernotifications/" target="_blank" rel="noopener">订阅文档</a> 当订阅发生改动时会向你的服务器发送通知. 这个为了订阅时效性可以选择接入。 我们这边只是写了接口 把订阅的数据存到database 没有做具体逻辑; 数据结构如下 </li>
</ul>
<pre><code class="mysql">/******************************************/
/*   DatabaseName = trade   */
/*   TableName = trade_payment_applepay_subscribe   */
/******************************************/
CREATE TABLE `trade_payment_applepay_subscribe` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `created` datetime(6) NOT NULL,
  `modified` datetime(6) NOT NULL,
  `is_removed` tinyint(1) NOT NULL,
  `user_id` int(11) NOT NULL DEFAULT 0,
  `order_no` varchar(64) NOT NULL DEFAULT &#39;&#39;,
  `auto_renew_adam_id` varchar(64) NOT NULL,
  `auto_renew_product_id` varchar(64) NOT NULL,
  `auto_renew_status` tinyint(1) NOT NULL,
  `auto_renew_status_change_date` datetime(6) NOT NULL,
  `auto_renew_status_change_date_ms` bigint(20) NOT NULL,
  `environment` varchar(16) NOT NULL,
  `expiration_intent` smallint(6) NOT NULL,
  `latest_expired_receipt` longtext NOT NULL,
  `latest_expired_receipt_info` longtext NOT NULL,
  `latest_receipt` longtext NOT NULL,
  `latest_receipt_info` longtext NOT NULL,
  `notification_type` varchar(64) NOT NULL,
  `unified_receipt` longtext NOT NULL,
  `password` varchar(128) NOT NULL,
  `transaction_id` varchar(32) NOT NULL,
  `original_transaction_id` varchar(32) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `trade_payment_applepay_subscribe_user_id_0a63f52c_idx` (`user_id`),
  KEY `trade_payment_applepay_subscribe_OTI_0a63f52c_idx` (`original_transaction_id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=190 DEFAULT CHARSET=utf8
;</code></pre>

    </div>
</article>

<div id="gitalk-container">
    <link rel="stylesheet" href="https://unpkg.com/gitalk@1.6.2/dist/gitalk.css">
<script src="https://geektutu.github.io/hexo-theme-geektutu/js/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: '01408711d79d72f03315',
        clientSecret: '238abe81d923c8392d36e3cdb14d29961f1870b2',
        accessToken: '997eb7f03bafcfef0d6b3030543c5a6e903fb771',
        id: window.location.pathname,
        repo: 'dadoudou.me',
        owner: 'zs1621',
        admin: 'zs1621',
        distractionFreeMode: 'true'
    })
    gitalk.render('gitalk-container')
</script>
</div>

<div id="paginator">
    
</div>


    </div>
</div>

<div id="bottom-outer">
    <div id="bottom-inner">
        2019-2020 zs1621 
    </div>
</div>

<div id="to-top">
    <i class="iconfont icon-up"></i>
</div>


    
        <script src="https://dadoudou.me/js/jquery-3.4.1.min.js"></script>
    
        <script src="https://dadoudou.me/js/highlight-9.13.1.min.js"></script>
    
        <script src="https://dadoudou.me/js/transition.js"></script>
    
        <script src="https://dadoudou.me/js/smooth-scroll.min.js"></script>
    



    <script>
      $(function () {
        $('#banner-outer').addClass('fade-out')
        $('#menu-outer').addClass('fade-show')

        $('pre').each(function (i, block) {
          hljs.highlightBlock(block);
        });
      })
    </script>


<script>
  $(function () {
    $(window).scroll(function () {
      if ($(window).scrollTop() > 150) {
        $("#to-top").fadeIn();
      } else {
        $("#to-top").fadeOut();
      }
    });
    $("#to-top").click(function () {
      $("body,html").animate({scrollTop: 0}, 500);
      return false;
    })
  })
</script>
</body>
</html>
